@page "/reportes"
@using AVritmica.Shared.DTO
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>AVritmica - Sistema de Reportes</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="text-primary">
                <i class="fas fa-chart-line me-2"></i>Sistema de Reportes
            </h3>
            <p class="text-muted">Genera reportes detallados de ventas, stock, compras y usuarios</p>
        </div>
    </div>

    <!-- Tarjetas de Resumen General -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Ventas Totales (Mes)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(resumenVentas?.TotalMontoVentas.ToString("C") ?? "Cargando...")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Valor Total Stock
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(resumenStock?.ValorTotalStock.ToString("C") ?? "Cargando...")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Compras (Mes)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(resumenCompras?.TotalInvertido.ToString("C") ?? "Cargando...")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-bag fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Usuarios Registrados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(resumenUsuarios?.TotalUsuarios.ToString() ?? "Cargando...")
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegación entre Reportes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="reportesTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ventas-tab" data-bs-toggle="tab"
                                    data-bs-target="#ventas" type="button" role="tab"
                                    aria-controls="ventas" aria-selected="true">
                                <i class="fas fa-chart-bar me-2"></i>Reporte de Ventas
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="stock-tab" data-bs-toggle="tab"
                                    data-bs-target="#stock" type="button" role="tab"
                                    aria-controls="stock" aria-selected="false">
                                <i class="fas fa-boxes me-2"></i>Reporte de Stock
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="compras-tab" data-bs-toggle="tab"
                                    data-bs-target="#compras" type="button" role="tab"
                                    aria-controls="compras" aria-selected="false">
                                <i class="fas fa-shopping-bag me-2"></i>Reporte de Compras
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="usuarios-tab" data-bs-toggle="tab"
                                    data-bs-target="#usuarios" type="button" role="tab"
                                    aria-controls="usuarios" aria-selected="false">
                                <i class="fas fa-users me-2"></i>Reporte de Usuarios
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="reportesTabContent">

                        <!-- REPORTE DE VENTAS -->
                        <div class="tab-pane fade show active" id="ventas" role="tabpanel" aria-labelledby="ventas-tab">
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" @bind="filtroVentas.FechaInicio" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" @bind="filtroVentas.FechaFin" />
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary me-2" @onclick="CargarReporteVentas">
                                        <i class="fas fa-search me-2"></i>Generar Reporte
                                    </button>
                                    <button class="btn btn-success" @onclick="ExportarVentasPDF" disabled="@(!reporteVentas.Any())">
                                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                    </button>
                                </div>
                            </div>

                            @if (cargandoVentas)
                            {
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            }
                            else if (reporteVentas.Any())
                            {
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card bg-primary text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenVentas.TotalVentas</h4>
                                                <p>Total Ventas</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenVentas.TotalMontoVentas.ToString("C")</h4>
                                                <p>Monto Total</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenVentas.TotalProductosVendidos</h4>
                                                <p>Productos Vendidos</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID Venta</th>
                                                <th>Fecha</th>
                                                <th>Cliente</th>
                                                <th>Estado</th>
                                                <th>Productos</th>
                                                <th>Monto Total</th>
                                                <th>Pagado</th>
                                                <th>Saldo</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var venta in reporteVentas)
                                            {
                                                <tr>
                                                    <td>#@venta.CarritoId</td>
                                                    <td>@venta.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                                    <td>@venta.Cliente</td>
                                                    <td>
                                                        <span class="badge @GetEstadoVentaBadge(venta.Estado)">
                                                            @venta.Estado
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">@venta.CantidadProductos</span>
                                                    </td>
                                                    <td>@venta.MontoTotal.ToString("C")</td>
                                                    <td>@venta.MontoPagado.ToString("C")</td>
                                                    <td>@venta.Saldo.ToString("C")</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" @onclick="() => VerDetallesVenta(venta.CarritoId)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-chart-bar fa-3x mb-3 text-muted"></i>
                                    <h4>No hay datos de ventas</h4>
                                    <p>Seleccione un rango de fechas y genere el reporte.</p>
                                </div>
                            }
                        </div>

                        <!-- REPORTE DE STOCK -->
                        <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <button class="btn btn-primary" @onclick="CargarReporteStock">
                                        <i class="fas fa-sync-alt me-2"></i>Actualizar Reporte
                                    </button>
                                    <button class="btn btn-success" @onclick="ExportarStockPDF" disabled="@(!reporteStock.Any())">
                                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                    </button>
                                </div>
                            </div>

                            @if (cargandoStock)
                            {
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            }
                            else if (reporteStock.Any())
                            {
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenStock.TotalProductos</h4>
                                                <p>Total Productos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenStock.ProductosConStockBajo</h4>
                                                <p>Stock Bajo</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-danger text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenStock.ProductosSinStock</h4>
                                                <p>Sin Stock</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenStock.ValorTotalStock.ToString("C")</h4>
                                                <p>Valor Total</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Producto</th>
                                                <th>Categoría</th>
                                                <th>Stock Actual</th>
                                                <th>Estado</th>
                                                <th>Entradas</th>
                                                <th>Salidas</th>
                                                <th>Precio</th>
                                                <th>Valor Stock</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in reporteStock)
                                            {
                                                <tr>
                                                    <td>@item.Producto</td>
                                                    <td>@item.Categoria</td>
                                                    <td>
                                                        <span class="badge @GetStockBadgeClass(item.StockActual)">
                                                            @item.StockActual
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge @GetEstadoStockBadge(item.EstadoStock)">
                                                            @item.EstadoStock
                                                        </span>
                                                    </td>
                                                    <td>@item.EntradasTotales</td>
                                                    <td>@item.SalidasTotales</td>
                                                    <td>@item.Precio.ToString("C")</td>
                                                    <td>@item.ValorStock.ToString("C")</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" @onclick="() => VerMovimientosStock(item.ProductoId)">
                                                            <i class="fas fa-history"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-boxes fa-3x mb-3 text-muted"></i>
                                    <h4>No hay datos de stock</h4>
                                    <p>No se encontraron productos en el inventario.</p>
                                </div>
                            }
                        </div>

                        <!-- REPORTE DE COMPRAS -->
                        <div class="tab-pane fade" id="compras" role="tabpanel" aria-labelledby="compras-tab">
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" @bind="filtroCompras.FechaInicio" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" @bind="filtroCompras.FechaFin" />
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary me-2" @onclick="CargarReporteCompras">
                                        <i class="fas fa-search me-2"></i>Generar Reporte
                                    </button>
                                    <button class="btn btn-success" @onclick="ExportarComprasPDF" disabled="@(!reporteCompras.Any())">
                                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                    </button>
                                </div>
                            </div>

                            @if (cargandoCompras)
                            {
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            }
                            else if (reporteCompras.Any())
                            {
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenCompras.TotalCompras</h4>
                                                <p>Total Compras</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenCompras.TotalUnidadesCompradas</h4>
                                                <p>Unidades Compradas</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenCompras.TotalProductosComprados</h4>
                                                <p>Productos Diferentes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenCompras.TotalInvertido.ToString("C")</h4>
                                                <p>Total Invertido</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID Compra</th>
                                                <th>Fecha</th>
                                                <th>Descripción</th>
                                                <th>Productos</th>
                                                <th>Unidades</th>
                                                <th>Total Compra</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var compra in reporteCompras)
                                            {
                                                <tr>
                                                    <td>#@compra.CompraId</td>
                                                    <td>@compra.FechaCompra.ToString("dd/MM/yyyy HH:mm")</td>
                                                    <td>@(string.IsNullOrEmpty(compra.Descripcion) ? "Sin descripción" : compra.Descripcion)</td>
                                                    <td>
                                                        <span class="badge bg-primary">@compra.CantidadProductos</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">@compra.TotalUnidades</span>
                                                    </td>
                                                    <td>@compra.TotalCompra.ToString("C")</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" @onclick="() => VerDetallesCompra(compra.CompraId)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-shopping-bag fa-3x mb-3 text-muted"></i>
                                    <h4>No hay datos de compras</h4>
                                    <p>Seleccione un rango de fechas y genere el reporte.</p>
                                </div>
                            }
                        </div>

                        <!-- REPORTE DE USUARIOS -->
                        <div class="tab-pane fade" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <button class="btn btn-primary" @onclick="CargarReporteUsuarios">
                                        <i class="fas fa-sync-alt me-2"></i>Actualizar Reporte
                                    </button>
                                    <button class="btn btn-success" @onclick="ExportarUsuariosPDF" disabled="@(!reporteUsuarios.Any())">
                                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                    </button>
                                </div>
                            </div>

                            @if (cargandoUsuarios)
                            {
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            }
                            else if (reporteUsuarios.Any())
                            {
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenUsuarios.TotalUsuarios</h4>
                                                <p>Total Usuarios</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenUsuarios.UsuariosClientes</h4>
                                                <p>Clientes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenUsuarios.UsuariosAdministradores</h4>
                                                <p>Administradores</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white mb-3">
                                            <div class="card-body text-center">
                                                <h4>@resumenUsuarios.UsuariosVendedores</h4>
                                                <p>Vendedores</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Email</th>
                                                <th>Tipo</th>
                                                <th>Total Carritos</th>
                                                <th>Carritos Activos</th>
                                                <th>Total Compras</th>
                                                <th>Consultas</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var usuario in reporteUsuarios)
                                            {
                                                <tr>
                                                    <td>@usuario.NombreCompleto</td>
                                                    <td>@usuario.Email</td>
                                                    <td>
                                                        <span class="badge @GetTipoUsuarioBadge(usuario.TipoUsuario)">
                                                            @usuario.TipoUsuario
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">@usuario.TotalCarritos</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">@usuario.CarritosActivos</span>
                                                    </td>
                                                    <td>@usuario.TotalCompras.ToString("C")</td>
                                                    <td>
                                                        <span class="badge bg-info">@usuario.ConsultasRealizadas</span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-info" @onclick="() => VerDetallesUsuario(usuario.UsuarioId)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-users fa-3x mb-3 text-muted"></i>
                                    <h4>No hay datos de usuarios</h4>
                                    <p>No se encontraron usuarios registrados en el sistema.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Variables para reportes
    private List<ReporteVentasDTO> reporteVentas = new();
    private List<ReporteStockDTO> reporteStock = new();
    private List<ReporteComprasDTO> reporteCompras = new();
    private List<ReporteUsuariosDTO> reporteUsuarios = new();

    // Resúmenes
    private ResumenVentasDTO resumenVentas = new();
    private ResumenStockDTO resumenStock = new();
    private ResumenComprasDTO resumenCompras = new();
    private ResumenUsuariosDTO resumenUsuarios = new();

    // Estados de carga
    private bool cargandoVentas = false;
    private bool cargandoStock = false;
    private bool cargandoCompras = false;
    private bool cargandoUsuarios = false;

    // Filtros
    private FiltroVentas filtroVentas = new();
    private FiltroCompras filtroCompras = new();

    protected override async Task OnInitializedAsync()
    {
        // Inicializar fechas por defecto (últimos 30 días)
        filtroVentas.FechaInicio = DateTime.Today.AddDays(-30);
        filtroVentas.FechaFin = DateTime.Today;
        filtroCompras.FechaInicio = DateTime.Today.AddDays(-30);
        filtroCompras.FechaFin = DateTime.Today;

        // Cargar datos iniciales
        await CargarResumenesGenerales();
        await CargarReporteStock();
        await CargarReporteUsuarios();
    }

    private async Task CargarResumenesGenerales()
    {
        try
        {
            var fechaInicio = DateTime.Today.AddDays(-30);
            var fechaFin = DateTime.Today;

            var ventasTask = Http.GetFromJsonAsync<ResumenVentasDTO>($"api/Reportes/ventas/resumen?fechaInicio={fechaInicio:yyyy-MM-dd}&fechaFin={fechaFin:yyyy-MM-dd}");
            var stockTask = Http.GetFromJsonAsync<ResumenStockDTO>("api/Reportes/stock/resumen");
            var comprasTask = Http.GetFromJsonAsync<ResumenComprasDTO>($"api/Reportes/compras/resumen?fechaInicio={fechaInicio:yyyy-MM-dd}&fechaFin={fechaFin:yyyy-MM-dd}");
            var usuariosTask = Http.GetFromJsonAsync<ResumenUsuariosDTO>("api/Reportes/usuarios/resumen");

            await Task.WhenAll(ventasTask, stockTask, comprasTask, usuariosTask);

            resumenVentas = ventasTask.Result ?? new();
            resumenStock = stockTask.Result ?? new();
            resumenCompras = comprasTask.Result ?? new();
            resumenUsuarios = usuariosTask.Result ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar resúmenes: {ex.Message}");
        }
    }

    private async Task CargarReporteVentas()
    {
        cargandoVentas = true;
        StateHasChanged();

        try
        {
            reporteVentas = await Http.GetFromJsonAsync<List<ReporteVentasDTO>>(
                $"api/Reportes/ventas/periodo?fechaInicio={filtroVentas.FechaInicio:yyyy-MM-dd}&fechaFin={filtroVentas.FechaFin:yyyy-MM-dd}") ?? new();

            resumenVentas = await Http.GetFromJsonAsync<ResumenVentasDTO>(
                $"api/Reportes/ventas/resumen?fechaInicio={filtroVentas.FechaInicio:yyyy-MM-dd}&fechaFin={filtroVentas.FechaFin:yyyy-MM-dd}") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar reporte de ventas: {ex.Message}");
        }
        finally
        {
            cargandoVentas = false;
            StateHasChanged();
        }
    }

    private async Task CargarReporteStock()
    {
        cargandoStock = true;
        StateHasChanged();

        try
        {
            reporteStock = await Http.GetFromJsonAsync<List<ReporteStockDTO>>("api/Reportes/stock") ?? new();
            resumenStock = await Http.GetFromJsonAsync<ResumenStockDTO>("api/Reportes/stock/resumen") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar reporte de stock: {ex.Message}");
        }
        finally
        {
            cargandoStock = false;
            StateHasChanged();
        }
    }

    private async Task CargarReporteCompras()
    {
        cargandoCompras = true;
        StateHasChanged();

        try
        {
            reporteCompras = await Http.GetFromJsonAsync<List<ReporteComprasDTO>>(
                $"api/Reportes/compras/periodo?fechaInicio={filtroCompras.FechaInicio:yyyy-MM-dd}&fechaFin={filtroCompras.FechaFin:yyyy-MM-dd}") ?? new();

            resumenCompras = await Http.GetFromJsonAsync<ResumenComprasDTO>(
                $"api/Reportes/compras/resumen?fechaInicio={filtroCompras.FechaInicio:yyyy-MM-dd}&fechaFin={filtroCompras.FechaFin:yyyy-MM-dd}") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar reporte de compras: {ex.Message}");
        }
        finally
        {
            cargandoCompras = false;
            StateHasChanged();
        }
    }

    private async Task CargarReporteUsuarios()
    {
        cargandoUsuarios = true;
        StateHasChanged();

        try
        {
            reporteUsuarios = await Http.GetFromJsonAsync<List<ReporteUsuariosDTO>>("api/Reportes/usuarios") ?? new();
            resumenUsuarios = await Http.GetFromJsonAsync<ResumenUsuariosDTO>("api/Reportes/usuarios/resumen") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar reporte de usuarios: {ex.Message}");
        }
        finally
        {
            cargandoUsuarios = false;
            StateHasChanged();
        }
    }

    // Métodos de navegación
    private void VerDetallesVenta(int carritoId)
    {
        Navigation.NavigateTo($"/carritos/detalles/{carritoId}");
    }

    private void VerMovimientosStock(int productoId)
    {
        Navigation.NavigateTo($"/stock-movimientos?productoId={productoId}");
    }

    private void VerDetallesCompra(int compraId)
    {
        Navigation.NavigateTo($"/compras/detalles/{compraId}");
    }

    private void VerDetallesUsuario(int usuarioId)
    {
        Navigation.NavigateTo($"/usuarios/detalles/{usuarioId}");
    }

    // Métodos de exportación (simulados)
    private async Task ExportarVentasPDF()
    {
        await JS.InvokeVoidAsync("alert", "Funcionalidad de exportación PDF para Ventas - En desarrollo");
    }

    private async Task ExportarStockPDF()
    {
        await JS.InvokeVoidAsync("alert", "Funcionalidad de exportación PDF para Stock - En desarrollo");
    }

    private async Task ExportarComprasPDF()
    {
        await JS.InvokeVoidAsync("alert", "Funcionalidad de exportación PDF para Compras - En desarrollo");
    }

    private async Task ExportarUsuariosPDF()
    {
        await JS.InvokeVoidAsync("alert", "Funcionalidad de exportación PDF para Usuarios - En desarrollo");
    }

    // Métodos auxiliares para estilos
    private string GetEstadoVentaBadge(string estado)
    {
        return estado switch
        {
            "Confirmado" => "bg-success",
            "Activo" => "bg-primary",
            "Cancelado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetStockBadgeClass(int stock)
    {
        if (stock <= 0) return "bg-danger";
        if (stock < 10) return "bg-warning";
        return "bg-success";
    }

    private string GetEstadoStockBadge(string estado)
    {
        return estado switch
        {
            "Sin Stock" => "bg-danger",
            "Stock Bajo" => "bg-warning",
            "Normal" => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetTipoUsuarioBadge(string tipo)
    {
        return tipo switch
        {
            "Administrador" => "bg-danger",
            "Vendedor" => "bg-warning",
            "Cliente" => "bg-success",
            _ => "bg-secondary"
        };
    }

    // Clases auxiliares para filtros
    public class FiltroVentas
    {
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
    }

    public class FiltroCompras
    {
        public DateTime FechaInicio { get; set; }
        public DateTime FechaFin { get; set; }
    }
}

<style>
    .card {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border: 1px solid #e3e6f0;
    }

    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }

    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }

    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }

    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }

    .nav-tabs .nav-link.active {
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: 600;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }
</style>

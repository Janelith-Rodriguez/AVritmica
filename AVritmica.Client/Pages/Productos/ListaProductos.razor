@page "/productos"
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<h3>Lista de Productos</h3>

@if (cargando)
{
    <div class="alert alert-info">
        <i class="fas fa-spinner fa-spin"></i> Cargando productos...
    </div>
}
else if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">
        <h5>Error al cargar productos</h5>
        <p>@mensajeError</p>
        <button class="btn btn-sm btn-outline-danger" @onclick="ReintentarCarga">Reintentar</button>
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoProducto">
            <i class="fas fa-plus"></i> Nuevo Producto
        </button>

        <button class="btn btn-outline-secondary ml-2" @onclick="RefrescarProductos" title="Refrescar lista">
            <i class="fas fa-sync-alt"></i> Refrescar
        </button>

        <div class="row mt-2">
            <div class="col-md-4">
                <label>Filtrar por categoría:</label>
                <select @bind="filtroCategoriaId" class="form-control">
                    <option value="0">Todas las categorías</option>
                    @foreach (var cat in categorias)
                    {
                        <option value="@cat.Id">@cat.Nombre</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @if (ProductosFiltrados.Count == 0)
    {
        <div class="alert alert-warning">
            No se encontraron productos @(filtroCategoriaId > 0 ? "para la categoría seleccionada" : "").
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Categoría</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var producto in ProductosFiltrados)
                    {
                        <tr>
                            <td>
                                <strong>@producto.Nombre</strong>
                                @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                                {
                                    <br />
                                    <small class="text-muted">
                                        <i class="fas fa-image"></i> Con imagen
                                    </small>
                                }
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(producto.Descripcion))
                                {
                                    <span class="text-muted">Sin descripción</span>
                                }
                                else if (producto.Descripcion.Length > 50)
                                {
                                    @producto.Descripcion.Substring(0, 50)
                                    <text>...</text>
                                }
                                else
                                {
                                    @producto.Descripcion
                                }
                            </td>
                            <td class="text-success">
                                <strong>@producto.Precio.ToString("C")</strong>
                            </td>
                            <td>
                                @if (producto.Stock > 0)
                                {
                                    <span class="badge badge-success">@producto.Stock</span>
                                }
                                else
                                {
                                    <span class="badge badge-danger">@producto.Stock</span>
                                }
                            </td>
                            <td>
                                <span class="badge badge-info">@(producto.Categoria?.Nombre ?? "Sin categoría")</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-info" @onclick="() => VerDetalles(producto)" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" @onclick="() => EditarProducto(producto.Id)" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => EliminarProducto(producto)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-2">
            <small class="text-muted">
                Mostrando @ProductosFiltrados.Count de @productos.Count producto(s)
                @if (filtroCategoriaId > 0)
                {
                    <span> - Filtrado por categoría</span>
                }
            </small>
        </div>
    }
}

@code {
    private List<Producto> productos = new();
    private List<Categoria> categorias = new();
    private bool cargando = true;
    private string mensajeError = string.Empty;
    private int filtroCategoriaId = 0;

    // Propiedad computada para los productos filtrados
    private List<Producto> ProductosFiltrados => GetProductosFiltrados();

    private List<Producto> GetProductosFiltrados()
    {
        if (filtroCategoriaId == 0)
            return productos;

        return productos.Where(p => p.CategoriaId == filtroCategoriaId).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        mensajeError = string.Empty;
        StateHasChanged();

        try
        {
            // Cargar categorías primero
            var catRespuesta = await CategoriaService.GetCategorias();
            if (catRespuesta.Error)
            {
                mensajeError = "Error al cargar las categorías";
            }
            else
            {
                categorias = catRespuesta.Respuesta ?? new List<Categoria>();
            }

            // Luego cargar productos
            await CargarProductos();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task CargarProductos()
    {
        try
        {
            var respuesta = await ProductoService.GetProductos();

            if (respuesta.Error)
            {
                mensajeError = "Error al cargar los productos. Verifique la conexión.";
            }
            else
            {
                productos = respuesta.Respuesta ?? new List<Producto>();
                mensajeError = string.Empty;
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
    }

    private async Task VerDetalles(Producto producto)
    {
        try
        {
            var descripcion = string.IsNullOrEmpty(producto.Descripcion) ? 
                "Sin descripción" : producto.Descripcion;
            
            var categoria = producto.Categoria?.Nombre ?? "Sin categoría";
            var imagenInfo = string.IsNullOrEmpty(producto.ImagenUrl) ? 
                "No tiene imagen" : "Tiene imagen";

            var detalles = $"DETALLES DEL PRODUCTO\n\n" +
                          $"Nombre: {producto.Nombre}\n" +
                          $"Descripción: {descripcion}\n" +
                          $"Precio: {producto.Precio:C}\n" +
                          $"Stock: {producto.Stock}\n" +
                          $"Categoría: {categoria}\n" +
                          $"Imagen: {imagenInfo}";

            await JS.InvokeVoidAsync("alert", detalles);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al mostrar detalles: {ex.Message}");
        }
    }

    private async Task RefrescarProductos()
    {
        await CargarProductos();
        StateHasChanged();
        
        try
        {
            await JS.InvokeVoidAsync("alert", "Lista de productos actualizada");
        }
        catch (Exception)
        {
            // Ignorar errores de JS si ocurren
        }
    }

    private async Task ReintentarCarga()
    {
        await CargarDatos();
    }

    private void NuevoProducto()
    {
        Navigation.NavigateTo("/productos/nuevo");
    }

    private void EditarProducto(int id)
    {
        Navigation.NavigateTo($"/productos/editar/{id}");
    }

    private async Task EliminarProducto(Producto producto)
    {
        try
        {
            var confirmado = await JS.InvokeAsync<bool>("confirm",
                $"¿Está seguro de eliminar el producto?\n\n\"{producto.Nombre}\"\n\nEsta acción no se puede deshacer.");

            if (confirmado)
            {
                var respuesta = await ProductoService.DeleteProducto(producto.Id);
                if (!respuesta.Error)
                {
                    await CargarProductos();
                    await JS.InvokeVoidAsync("alert", "Producto eliminado exitosamente");
                }
                else
                {
                    var error = await respuesta.ObtenerError();
                    await JS.InvokeVoidAsync("alert", $"Error al eliminar: {error}");
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }
}
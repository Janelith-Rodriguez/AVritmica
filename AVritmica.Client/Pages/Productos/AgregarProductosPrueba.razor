@page "/agregar-productos-prueba"
@using AVritmica.Shared.DTO
@inject IProductoService ProductoService
@inject ICategoriaService CategoriaService
@inject NavigationManager Navigation

<h3>Agregar Productos de Prueba</h3>

@if (cargando)
{
    <div class="alert alert-info">Procesando...</div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="AgregarProductosPruebaHandler">Agregar Productos de Prueba</button>
        <button class="btn btn-secondary" @onclick="IrAProductos">Ir a Lista de Productos</button>
    </div>
}

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-info mt-3">@mensaje</div>
}

@if (productosCreados.Any())
{
    <div class="mt-3">
        <h5>Productos Creados:</h5>
        <ul>
            @foreach (var producto in productosCreados)
            {
                <li>@producto.Nombre - $@producto.Precio</li>
            }
        </ul>
    </div>
}

@code {
    private bool cargando = false;
    private string mensaje = string.Empty;
    private List<CrearProductoDTO> productosCreados = new();

    // Renombrar el método para evitar conflicto con el nombre del componente
    private async Task AgregarProductosPruebaHandler()
    {
        cargando = true;
        mensaje = "Creando productos de prueba...";
        productosCreados.Clear();
        StateHasChanged();

        try
        {
            // Obtener categorías existentes
            var catRespuesta = await CategoriaService.GetCategorias();
            if (catRespuesta.Error || catRespuesta.Respuesta == null || !catRespuesta.Respuesta.Any())
            {
                mensaje = "Error: No hay categorías disponibles. Crea categorías primero.";
                cargando = false;
                StateHasChanged();
                return;
            }

            var categorias = catRespuesta.Respuesta;
            var primeraCategoriaId = categorias.First().Id;

            // Productos de prueba
            var productosPrueba = new List<CrearProductoDTO>
            {
                new CrearProductoDTO 
                { 
                    Nombre = "Laptop HP Pavilion", 
                    Descripcion = "Laptop con 8GB RAM, 256GB SSD", 
                    Precio = 899.99m, 
                    Stock = 10,
                    CategoriaId = primeraCategoriaId
                },
                new CrearProductoDTO 
                { 
                    Nombre = "Mouse Inalámbrico", 
                    Descripcion = "Mouse óptico inalámbrico", 
                    Precio = 25.50m, 
                    Stock = 50,
                    CategoriaId = primeraCategoriaId
                },
                new CrearProductoDTO 
                { 
                    Nombre = "Teclado Mecánico", 
                    Descripcion = "Teclado mecánico RGB", 
                    Precio = 89.99m, 
                    Stock = 15,
                    CategoriaId = primeraCategoriaId
                }
            };

            foreach (var producto in productosPrueba)
            {
                var respuesta = await ProductoService.CreateProducto(producto);
                if (!respuesta.Error)
                {
                    productosCreados.Add(producto);
                }
            }

            mensaje = $"Se crearon {productosCreados.Count} productos de prueba exitosamente.";
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
        }

        cargando = false;
        StateHasChanged();
    }

    private void IrAProductos()
    {
        Navigation.NavigateTo("/productos");
    }
}

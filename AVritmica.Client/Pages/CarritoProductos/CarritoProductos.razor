@page "/carrito-productos"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gestión de Productos en Carritos</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoCarritoProducto">Agregar Producto a Carrito</button>
        <button class="btn btn-outline-secondary" @onclick="Refrescar">Refrescar</button>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Buscar por producto..." @bind="terminoBusqueda" @oninput="OnBuscar" />
        </div>
        <div class="col-md-4">
            <select class="form-select" @bind="carritoFiltro">
                <option value="0">Todos los carritos</option>
                @foreach (var carrito in carritos)
                {
                    <option value="@carrito.Id">Carrito #@carrito.Id - @carrito.Usuario?.Nombre</option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select" @bind="productoFiltro">
                <option value="0">Todos los productos</option>
                @foreach (var producto in productos)
                {
                    <option value="@producto.Id">@producto.Nombre</option>
                }
            </select>
        </div>
    </div>

    @if (carritoProductos?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Carrito</th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var carritoProducto in carritoProductosFiltrados)
                    {
                        <tr>
                            <td>@carritoProducto.Id</td>
                            <td>
                                <small class="text-muted">#@carritoProducto.CarritoId</small><br>
                                <strong>@carritoProducto.Carrito?.Usuario?.Nombre</strong>
                            </td>
                            <td>
                                <strong>@carritoProducto.Producto?.Nombre</strong><br>
                                <small class="text-muted">@carritoProducto.Producto?.Categoria?.Nombre</small>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => DisminuirCantidad(carritoProducto)" title="Disminuir">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="mx-2">@carritoProducto.Cantidad</span>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => AumentarCantidad(carritoProducto)" title="Aumentar">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </td>
                            <td>@carritoProducto.PrecioUnitario.ToString("C")</td>
                            <td>
                                <strong>@((carritoProducto.Cantidad * carritoProducto.PrecioUnitario).ToString("C"))</strong>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" @onclick="() => VerDetalles(carritoProducto.Id)" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" @onclick="() => EditarCarritoProducto(carritoProducto.Id)" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => EliminarCarritoProducto(carritoProducto)" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="table-primary">
                        <td colspan="5" class="text-end"><strong>Total General:</strong></td>
                        <td><strong>@carritoProductosFiltrados.Sum(cp => cp.Cantidad * cp.PrecioUnitario).ToString("C")</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No se encontraron productos en carritos.
        </div>
    }
}

@code {
    private List<CarritoProducto> carritoProductos = new();
    private List<CarritoProducto> carritoProductosFiltrados = new();
    private List<Carrito> carritos = new();
    private List<Producto> productos = new();
    private bool cargando = true;
    private string terminoBusqueda = string.Empty;
    private int carritoFiltro = 0;
    private int productoFiltro = 0;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var tasks = new Task[]
            {
                CargarCarritoProductos(),
                CargarCarritos(),
                CargarProductos()
            };

            await Task.WhenAll(tasks);
            FiltrarCarritoProductos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar datos: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task CargarCarritoProductos()
    {
        carritoProductos = await Http.GetFromJsonAsync<List<CarritoProducto>>("api/CarritoProductos") ?? new();
    }

    private async Task CargarCarritos()
    {
        carritos = await Http.GetFromJsonAsync<List<Carrito>>("api/Carritos") ?? new();
    }

    private async Task CargarProductos()
    {
        productos = await Http.GetFromJsonAsync<List<Producto>>("api/Productos") ?? new();
    }

    private void FiltrarCarritoProductos()
    {
        carritoProductosFiltrados = carritoProductos;

        if (!string.IsNullOrEmpty(terminoBusqueda))
        {
            carritoProductosFiltrados = carritoProductosFiltrados.Where(cp =>
                cp.Producto?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                cp.Producto?.Categoria?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                cp.Carrito?.Usuario?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true
            ).ToList();
        }

        if (carritoFiltro > 0)
        {
            carritoProductosFiltrados = carritoProductosFiltrados.Where(cp => cp.CarritoId == carritoFiltro).ToList();
        }

        if (productoFiltro > 0)
        {
            carritoProductosFiltrados = carritoProductosFiltrados.Where(cp => cp.ProductoId == productoFiltro).ToList();
        }
    }

    private void OnBuscar(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? string.Empty;
        FiltrarCarritoProductos();
    }

    private async Task AumentarCantidad(CarritoProducto carritoProducto)
    {
        var nuevaCantidad = carritoProducto.Cantidad + 1;
        await ActualizarCantidad(carritoProducto, nuevaCantidad);
    }

    private async Task DisminuirCantidad(CarritoProducto carritoProducto)
    {
        if (carritoProducto.Cantidad > 1)
        {
            var nuevaCantidad = carritoProducto.Cantidad - 1;
            await ActualizarCantidad(carritoProducto, nuevaCantidad);
        }
        else
        {
            await EliminarCarritoProducto(carritoProducto);
        }
    }

    private async Task ActualizarCantidad(CarritoProducto carritoProducto, int nuevaCantidad)
    {
        try
        {
            var response = await Http.PostAsJsonAsync($"api/CarritoProductos/actualizar-cantidad/{carritoProducto.Id}", nuevaCantidad);

            if (response.IsSuccessStatusCode)
            {
                carritoProducto.Cantidad = nuevaCantidad;
                StateHasChanged();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Error al actualizar la cantidad");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void NuevoCarritoProducto()
    {
        Navigation.NavigateTo("/carrito-productos/nuevo");
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"/carrito-productos/detalles/{id}");
    }

    private void EditarCarritoProducto(int id)
    {
        Navigation.NavigateTo($"/carrito-productos/editar/{id}");
    }

    private async Task EliminarCarritoProducto(CarritoProducto carritoProducto)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar {carritoProducto.Cantidad} x {carritoProducto.Producto?.Nombre} del carrito #{carritoProducto.CarritoId}?");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/CarritoProductos/{carritoProducto.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Producto eliminado del carrito correctamente");
                    await CargarCarritoProductos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al eliminar el producto del carrito");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task Refrescar()
    {
        await CargarDatos();
    }
}

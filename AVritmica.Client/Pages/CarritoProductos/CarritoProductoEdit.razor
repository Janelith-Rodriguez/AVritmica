@page "/carrito-productos/editar/{id:int}"
@page "/carrito-productos/nuevo"
@using AVritmica.Shared.DTO
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>@Titulo</h3>

<EditForm Model="carritoProductoDTO" OnValidSubmit="GuardarCarritoProducto">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="carritoId" class="form-label">Carrito *</label>
                <InputSelect id="carritoId" class="form-select" @bind-Value="carritoProductoDTO.CarritoId">
                    <option value="0">Seleccione un carrito</option>
                    @foreach (var carrito in carritos)
                    {
                        <option value="@carrito.Id">#@carrito.Id - @carrito.Usuario?.Nombre (@carrito.Estado)</option>
                    }
                </InputSelect>
                @if (carritoProductoDTO.CarritoId == 0)
                {
                    <div class="text-danger">Debe seleccionar un carrito</div>
                }
            </div>

            <div class="mb-3">
                <label for="productoId" class="form-label">Producto *</label>
                <InputSelect id="productoId" class="form-select" @bind-Value="carritoProductoDTO.ProductoId">
                    <option value="0">Seleccione un producto</option>
                    @foreach (var producto in productos)
                    {
                        <option value="@producto.Id">@producto.Nombre - @producto.Precio.ToString("C")</option>
                    }
                </InputSelect>
                @if (carritoProductoDTO.ProductoId == 0)
                {
                    <div class="text-danger">Debe seleccionar un producto</div>
                }
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="cantidad" class="form-label">Cantidad *</label>
                <InputNumber id="cantidad" class="form-control" @bind-Value="carritoProductoDTO.Cantidad" min="1" />
                <ValidationMessage For="@(() => carritoProductoDTO.Cantidad)" />
            </div>

            <div class="mb-3">
                <label for="precioUnitario" class="form-label">Precio Unitario *</label>
                <InputNumber id="precioUnitario" class="form-control" @bind-Value="carritoProductoDTO.PrecioUnitario" step="0.01" />
                <ValidationMessage For="@(() => carritoProductoDTO.PrecioUnitario)" />
            </div>

            @if (carritoProductoDTO.Cantidad > 0 && carritoProductoDTO.PrecioUnitario > 0)
            {
                <div class="alert alert-info">
                    <strong>Subtotal:</strong> @((carritoProductoDTO.Cantidad * carritoProductoDTO.PrecioUnitario).ToString("C"))
                </div>
            }
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary" disabled="@guardando">@BotonGuardarTexto</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private CarritoProductoDTO carritoProductoDTO = new();
    private List<Carrito> carritos = new();
    private List<Producto> productos = new();
    private bool guardando = false;
    private bool EsEdicion => Id > 0;

    private string Titulo => EsEdicion ? "Editar Producto en Carrito" : "Agregar Producto a Carrito";
    private string BotonGuardarTexto => guardando ? "Guardando..." : "Guardar";

    protected override async Task OnInitializedAsync()
    {
        await CargarListas();

        if (EsEdicion)
        {
            await CargarCarritoProducto();
        }
        else
        {
            // Valores por defecto para nuevo
            carritoProductoDTO.Cantidad = 1;
        }
    }

    private async Task CargarListas()
    {
        try
        {
            var tasks = new Task[]
            {
                CargarCarritos(),
                CargarProductos()
            };

            await Task.WhenAll(tasks);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar listas: {ex.Message}");
        }
    }

    private async Task CargarCarritos()
    {
        carritos = await Http.GetFromJsonAsync<List<Carrito>>("api/Carritos") ?? new();
    }

    private async Task CargarProductos()
    {
        productos = await Http.GetFromJsonAsync<List<Producto>>("api/Productos") ?? new();
    }

    private async Task CargarCarritoProducto()
    {
        try
        {
            var carritoProducto = await Http.GetFromJsonAsync<CarritoProducto>($"api/CarritoProductos/{Id}");
            if (carritoProducto != null)
            {
                carritoProductoDTO = new CarritoProductoDTO
                {
                    Id = carritoProducto.Id,
                    CarritoId = carritoProducto.CarritoId,
                    ProductoId = carritoProducto.ProductoId,
                    Cantidad = carritoProducto.Cantidad,
                    PrecioUnitario = carritoProducto.PrecioUnitario
                };
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar producto del carrito: {ex.Message}");
        }
    }

    private async Task GuardarCarritoProducto()
    {
        // Validación del lado del cliente
        if (carritoProductoDTO.CarritoId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Por favor seleccione un carrito");
            return;
        }

        if (carritoProductoDTO.ProductoId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Por favor seleccione un producto");
            return;
        }

        if (carritoProductoDTO.Cantidad <= 0)
        {
            await JS.InvokeVoidAsync("alert", "La cantidad debe ser mayor a 0");
            return;
        }

        if (carritoProductoDTO.PrecioUnitario <= 0)
        {
            await JS.InvokeVoidAsync("alert", "El precio unitario debe ser mayor a 0");
            return;
        }

        guardando = true;
        StateHasChanged();

        try
        {
            HttpResponseMessage response;

            if (EsEdicion)
            {
                // Usar el nuevo endpoint DTO
                carritoProductoDTO.Id = Id;
                response = await Http.PutAsJsonAsync($"api/CarritoProductos/actualizar/{Id}", carritoProductoDTO);
            }
            else
            {
                // Usar el nuevo endpoint DTO
                response = await Http.PostAsJsonAsync("api/CarritoProductos/crear", carritoProductoDTO);
            }

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Producto del carrito guardado correctamente");
                Navigation.NavigateTo("/carrito-productos");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/carrito-productos");
    }
}
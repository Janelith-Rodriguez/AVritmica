@page "/compra-detalles"
@page "/compra-detalles/{CompraId:int}"
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>AVritmica - Detalles de Compra</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h3 class="text-primary">
                <i class="fas fa-list-alt me-2"></i>Detalles de Compra
                @if (CompraId > 0)
                {
                    <span class="text-muted">- Compra #@CompraId</span>
                }
            </h3>
        </div>
        <div class="col-auto">
            <button class="btn btn-success" @onclick="Nuevo">
                <i class="fas fa-plus me-1"></i>Nuevo Detalle
            </button>
            @if (CompraId > 0)
            {
                <button class="btn btn-secondary ms-2" @onclick="VolverACompras">
                    <i class="fas fa-arrow-left me-1"></i>Volver a Compras
                </button>
            }
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Buscar por Producto:</label>
                    <input type="text" class="form-control" @bind="filtroProducto"
                           @bind:event="oninput" placeholder="Nombre del producto..." />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Compra:</label>
                    <select class="form-select" @bind="filtroCompraId">
                        <option value="0">Todas las compras</option>
                        @foreach (var compra in compras)
                        {
                            <option value="@compra.Id">Compra del @compra.FechaCompra.ToString("dd/MM/yyyy")</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Producto:</label>
                    <select class="form-select" @bind="filtroProductoId">
                        <option value="0">Todos los productos</option>
                        @foreach (var producto in productos)
                        {
                            <option value="@producto.Id">@producto.Nombre</option>
                        }
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
                        <i class="fas fa-times me-1"></i>Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    @if (CompraId > 0 && estadisticas != null)
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h6 class="card-title">Total Productos</h6>
                        <h4>@estadisticas.TotalProductos</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6 class="card-title">Total Unidades</h6>
                        <h4>@estadisticas.TotalUnidades</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h6 class="card-title">Total Compra</h6>
                        <h4>@estadisticas.TotalCompra.ToString("C2")</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h6 class="card-title">Acciones</h6>
                        <button class="btn btn-light btn-sm" @onclick="VerEstadisticasDetalladas">
                            <i class="fas fa-chart-bar me-1"></i>Ver Detalles
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Loading -->
    @if (cargando)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando detalles de compra...</p>
        </div>
    }

    <!-- Tabla -->
    @if (!cargando && compraDetalles.Any())
    {
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Detalles de Compra (@compraDetallesFiltrados.Count() registros)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Compra</th>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio Compra</th>
                                <th class="text-end">Precio Venta</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detalle in compraDetallesFiltrados)
                            {
                                <tr>
                                    <td>
                                        <small class="text-muted">@detalle.Compra?.FechaCompra.ToString("dd/MM/yyyy")</small>
                                    </td>
                                    <td>
                                        <strong>@detalle.Producto?.Nombre</strong><br>
                                        <small class="text-muted">@detalle.Producto?.Codigo</small>
                                    </td>
                                    <td>@detalle.Producto?.Categoria?.Nombre</td>
                                    <td class="text-center">
                                        <span class="badge bg-primary rounded-pill">@detalle.Cantidad</span>
                                    </td>
                                    <td class="text-end">@detalle.PrecioCompra.ToString("C2")</td>
                                    <td class="text-end">@detalle.PrecioVentaActualizado.ToString("C2")</td>
                                    <td class="text-end fw-bold text-success">
                                        @((detalle.Cantidad * detalle.PrecioCompra).ToString("C2"))
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-info" @onclick="() => VerDetalles(detalle.Id)" title="Ver Detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning" @onclick="() => Editar(detalle.Id)" title="Editar">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                            <button class="btn btn-danger" @onclick="() => Eliminar(detalle)" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        @if (CompraId > 0)
                        {
                            <tfoot class="table-secondary">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">TOTAL COMPRA:</td>
                                    <td class="text-center fw-bold">@compraDetalles.Sum(x => x.Cantidad)</td>
                                    <td colspan="2"></td>
                                    <td class="text-end fw-bold text-success fs-5">
                                        @compraDetalles.Sum(x => x.Cantidad * x.PrecioCompra).ToString("C2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        }
                    </table>
                </div>
            </div>
        </div>
    }
    else if (!cargando)
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            @if (CompraId > 0)
            {
                <span>No se encontraron detalles para la compra.</span>
            }
            else
            {
                <span>No se encontraron detalles de compra.</span>
            }
            <button class="btn btn-sm btn-primary ms-2" @onclick="Nuevo">
                <i class="fas fa-plus me-1"></i>Agregar el primer detalle
            </button>
        </div>
    }
</div>

<!-- Modal para Estadísticas Detalladas -->
@if (mostrarEstadisticasDetalladas)
{
    <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Estadísticas Detalladas - Compra
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarEstadisticas"></button>
                </div>
                <div class="modal-body">
                    @if (estadisticas != null)
                    {
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary">@estadisticas.TotalProductos</h3>
                                        <p class="mb-0">Productos Diferentes</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h3 class="text-success">@estadisticas.TotalUnidades</h3>
                                        <p class="mb-0">Total Unidades</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <h3 class="text-info">@estadisticas.TotalCompra.ToString("C2")</h3>
                                        <p class="mb-0">Inversión Total</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5>Detalle por Producto</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unitario</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var producto in estadisticas.Productos)
                                    {
                                        <tr>
                                            <td>@producto.Nombre</td>
                                            <td class="text-center">@producto.Cantidad</td>
                                            <td class="text-end">@(producto.Subtotal / producto.Cantidad).ToString("C2")</td>
                                            <td class="text-end fw-bold">@producto.Subtotal.ToString("C2")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th>TOTAL</th>
                                        <th class="text-center">@estadisticas.TotalUnidades</th>
                                        <th></th>
                                        <th class="text-end">@estadisticas.TotalCompra.ToString("C2")</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarEstadisticas">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int CompraId { get; set; }

    private List<CompraDetalle> compraDetalles = new();
    private List<Compra> compras = new();
    private List<Producto> productos = new();
    private IEnumerable<CompraDetalle> compraDetallesFiltrados => FiltrarDetalles();
    private bool cargando = true;
    private string filtroProducto = string.Empty;
    private int filtroCompraId = 0;
    private int filtroProductoId = 0;
    private bool mostrarEstadisticasDetalladas = false;
    private EstadisticasCompraResponse? estadisticas;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    protected override async Task OnParametersSetAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            // Cargar compras y productos para filtros
            var comprasTask = Http.GetFromJsonAsync<List<Compra>>("api/Compras");
            var productosTask = Http.GetFromJsonAsync<List<Producto>>("api/Productos");

            await Task.WhenAll(comprasTask, productosTask);

            compras = comprasTask.Result ?? new List<Compra>();
            productos = productosTask.Result ?? new List<Producto>();

            if (CompraId > 0)
            {
                // Cargar detalles específicos de una compra
                var response = await Http.GetFromJsonAsync<List<CompraDetalle>>($"api/CompraDetalles/GetByCompra/{CompraId}");
                compraDetalles = response ?? new List<CompraDetalle>();

                // Cargar estadísticas
                var statsResponse = await Http.GetFromJsonAsync<EstadisticasCompraResponse>($"api/CompraDetalles/estadisticas-compra/{CompraId}");
                estadisticas = statsResponse;
            }
            else
            {
                // Cargar todos los detalles
                var response = await Http.GetFromJsonAsync<List<CompraDetalle>>("api/CompraDetalles");
                compraDetalles = response ?? new List<CompraDetalle>();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar los detalles: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private IEnumerable<CompraDetalle> FiltrarDetalles()
    {
        var filtrados = compraDetalles.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(filtroProducto))
        {
            filtrados = filtrados.Where(x =>
                x.Producto?.Nombre?.Contains(filtroProducto, StringComparison.OrdinalIgnoreCase) == true ||
                x.Producto?.Codigo?.Contains(filtroProducto, StringComparison.OrdinalIgnoreCase) == true);
        }

        if (filtroCompraId > 0)
        {
            filtrados = filtrados.Where(x => x.CompraId == filtroCompraId);
        }

        if (filtroProductoId > 0)
        {
            filtrados = filtrados.Where(x => x.ProductoId == filtroProductoId);
        }

        return filtrados;
    }

    private void Nuevo()
    {
        var url = CompraId > 0 ? $"compra-detalle-editar/0/{CompraId}" : "compra-detalle-editar/0";
        Navigation.NavigateTo(url);
    }

    private void Editar(int id)
    {
        Navigation.NavigateTo($"compra-detalle-editar/{id}");
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"compra-detalle-detalles/{id}");
    }

    private async void Eliminar(CompraDetalle detalle)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar el detalle de compra?\n\n" +
            $"Producto: {detalle.Producto?.Nombre}\n" +
            $"Cantidad: {detalle.Cantidad}\n" +
            $"Precio: {detalle.PrecioCompra.ToString("C2")}\n\n" +
            "Esta acción no se puede deshacer.");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/CompraDetalles/{detalle.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Detalle de compra eliminado correctamente");
                    await CargarDatos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "❌ Error al eliminar el detalle de compra");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
            }
        }
    }

    private void LimpiarFiltros()
    {
        filtroProducto = string.Empty;
        filtroCompraId = 0;
        filtroProductoId = 0;
    }

    private void VolverACompras()
    {
        Navigation.NavigateTo("/compras");
    }

    private void VerEstadisticasDetalladas()
    {
        mostrarEstadisticasDetalladas = true;
    }

    private void CerrarEstadisticas()
    {
        mostrarEstadisticasDetalladas = false;
    }


    // Clases para las respuestas
    public class EstadisticasCompraResponse
    {
        public int TotalProductos { get; set; }
        public int TotalUnidades { get; set; }
        public decimal TotalCompra { get; set; }
        public List<ProductoResumen> Productos { get; set; } = new();
    }

    public class ProductoResumen
    {
        public string Nombre { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public decimal Subtotal { get; set; }
    }

    // Clases para la entidad (simplificadas para Blazor)
    public class CompraDetalle
    {
        public int Id { get; set; }
        public int CompraId { get; set; }
        public int ProductoId { get; set; }
        public int Cantidad { get; set; }
        public decimal PrecioCompra { get; set; }
        public decimal PrecioVentaActualizado { get; set; }
        public Compra? Compra { get; set; }
        public Producto? Producto { get; set; }
    }

    public class Compra
    {
        public int Id { get; set; }
        public DateTime FechaCompra { get; set; }
    }

    public class Producto
    {
        public int Id { get; set; }
        public string? Nombre { get; set; }
        public string? Codigo { get; set; }
        public Categoria? Categoria { get; set; }
    }

    public class Categoria
    {
        public int Id { get; set; }
        public string? Nombre { get; set; }
    }
}
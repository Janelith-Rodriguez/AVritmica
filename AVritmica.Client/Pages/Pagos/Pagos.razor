@page "/pagos"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gestión de Pagos</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando pagos...</p>
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoPago">
            <i class="fas fa-plus me-1"></i> Nuevo Pago
        </button>
        <button class="btn btn-outline-secondary" @onclick="Refrescar">
            <i class="fas fa-sync-alt me-1"></i> Refrescar
        </button>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Buscar por usuario..." @bind="terminoBusqueda" @oninput="OnBuscar" />
        </div>
        <div class="col-md-4">
            <select class="form-select" @bind="filtroEstado">
                <option value="">Todos los estados</option>
                <option value="Completado">Completado</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Fallido">Fallido</option>
                <option value="Reembolsado">Reembolsado</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select" @bind="filtroMetodo">
                <option value="">Todos los métodos</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Efectivo">Efectivo</option>
                <option value="PayPal">PayPal</option>
                <option value="MercadoPago">MercadoPago</option>
            </select>
        </div>
    </div>

    @if (pagos?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Método</th>
                        <th class="text-end">Monto</th>
                        <th>Estado</th>
                        <th class="text-end">Saldo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pago in pagosFiltrados)
                    {
                        <tr>
                            <td>
                                <strong>@pago.Carrito?.Usuario?.Nombre</strong><br>
                                <small class="text-muted">@pago.Carrito?.Usuario?.Email</small>
                            </td>
                            <td>
                                <small>@pago.FechaPago.ToString("dd/MM/yyyy")</small><br>
                                <small class="text-muted">@pago.FechaPago.ToString("HH:mm")</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">@pago.MetodoPago</span>
                            </td>
                            <td class="text-end">
                                <strong>@pago.MontoPagado.ToString("C")</strong>
                            </td>
                            <td>
                                <span class="badge @GetEstadoPagoBadgeClass(pago.EstadoPago)">@pago.EstadoPago</span>
                            </td>
                            <td class="text-end @(pago.Saldo > 0 ? "text-warning" : "text-success")">
                                <strong>@pago.Saldo.ToString("C")</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-info" @onclick="() => VerDetalles(pago.Id)" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-warning" @onclick="() => EditarPago(pago.Id)" title="Editar">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="btn btn-danger" @onclick="() => EliminarPago(pago)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" @onclick="() => CambiarEstado(pago)" title="Cambiar estado">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="table-primary">
                        <td colspan="3" class="text-end"><strong>Total General:</strong></td>
                        <td class="text-end"><strong>@pagosFiltrados.Sum(p => p.MontoPagado).ToString("C")</strong></td>
                        <td></td>
                        <td class="text-end"><strong>@pagosFiltrados.Sum(p => p.Saldo).ToString("C")</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="alert alert-info">
            <i class="fas fa-chart-bar me-2"></i>
            <strong>Resumen:</strong>
            @pagosFiltrados.Count pagos -
            Total Pagado: @pagosFiltrados.Sum(p => p.MontoPagado).ToString("C") -
            Saldo Pendiente: @pagosFiltrados.Sum(p => p.Saldo).ToString("C")
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No se encontraron pagos.
        </div>
    }
}

@code {
    private List<Pago> pagos = new();
    private List<Pago> pagosFiltrados = new();
    private bool cargando = true;
    private string terminoBusqueda = string.Empty;
    private string filtroEstado = string.Empty;
    private string filtroMetodo = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            pagos = await Http.GetFromJsonAsync<List<Pago>>("api/Pagos") ?? new();
            FiltrarPagos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error al cargar pagos: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private void FiltrarPagos()
    {
        pagosFiltrados = pagos;

        if (!string.IsNullOrEmpty(terminoBusqueda))
        {
            pagosFiltrados = pagosFiltrados.Where(p =>
                p.Carrito?.Usuario?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                p.Carrito?.Usuario?.Email?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                p.MetodoPago?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true
            ).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEstado))
        {
            pagosFiltrados = pagosFiltrados.Where(p => p.EstadoPago == filtroEstado).ToList();
        }

        if (!string.IsNullOrEmpty(filtroMetodo))
        {
            pagosFiltrados = pagosFiltrados.Where(p => p.MetodoPago == filtroMetodo).ToList();
        }
    }

    private void OnBuscar(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? string.Empty;
        FiltrarPagos();
    }

    private string GetEstadoPagoBadgeClass(string estadoPago)
    {
        return estadoPago switch
        {
            "Completado" => "bg-success",
            "Pendiente" => "bg-warning",
            "Fallido" => "bg-danger",
            "Reembolsado" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private void NuevoPago()
    {
        Navigation.NavigateTo("/pagos/nuevo");
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"/pagos/detalles/{id}");
    }

    private void EditarPago(int id)
    {
        Navigation.NavigateTo($"/pagos/editar/{id}");
    }

    private async Task EliminarPago(Pago pago)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar el pago?\n\n" +
            $"Usuario: {pago.Carrito?.Usuario?.Nombre}\n" +
            $"Monto: {pago.MontoPagado.ToString("C")}\n" +
            $"Método: {pago.MetodoPago}\n" +
            $"Fecha: {pago.FechaPago.ToString("dd/MM/yyyy HH:mm")}\n\n" +
            "Esta acción no se puede deshacer.");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/Pagos/{pago.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Pago eliminado correctamente");
                    await CargarDatos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "❌ Error al eliminar el pago");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
            }
        }
    }

    private async Task CambiarEstado(Pago pago)
    {
        var nuevoEstado = await JS.InvokeAsync<string>("prompt",
            $"Ingrese el nuevo estado para el pago de {pago.Carrito?.Usuario?.Nombre}:",
            pago.EstadoPago);

        if (!string.IsNullOrEmpty(nuevoEstado))
        {
            try
            {
                var response = await Http.PostAsJsonAsync($"api/Pagos/actualizar-estado/{pago.Id}", nuevoEstado);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Estado del pago actualizado correctamente");
                    await CargarDatos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "❌ Error al actualizar el estado del pago");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
            }
        }
    }

    private async Task Refrescar()
    {
        await CargarDatos();
        await JS.InvokeVoidAsync("alert", "✅ Lista de pagos actualizada");
    }

    // Clases para la entidad
    public class Pago
    {
        public int Id { get; set; }
        public int CarritoId { get; set; }
        public DateTime FechaPago { get; set; }
        public string MetodoPago { get; set; } = string.Empty;
        public decimal MontoPagado { get; set; }
        public string EstadoPago { get; set; } = string.Empty;
        public decimal Saldo { get; set; }
        public Carrito? Carrito { get; set; }
    }

    public class Carrito
    {
        public int Id { get; set; }
        public Usuario? Usuario { get; set; }
        public decimal MontoTotal { get; set; }
        public string Estado { get; set; } = string.Empty;
        public string EstadoPago { get; set; } = string.Empty;
        public List<CarritoProducto> CarritoProductos { get; set; } = new();
    }

    public class Usuario
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    public class CarritoProducto
    {
        public int Id { get; set; }
        public int ProductoId { get; set; }
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; }
        public Producto? Producto { get; set; }
    }

    public class Producto
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
    }
}

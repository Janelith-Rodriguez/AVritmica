@page "/pagos"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gestión de Pagos</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoPago">Nuevo Pago</button>
        <button class="btn btn-success" @onclick="ProcesarPago">Procesar Pago</button>
        <button class="btn btn-outline-secondary" @onclick="Refrescar">Refrescar</button>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Buscar..." @bind="terminoBusqueda" @oninput="OnBuscar" />
        </div>
        <div class="col-md-2">
            <select class="form-select" @bind="filtroEstado">
                <option value="">Todos los estados</option>
                <option value="Completado">Completado</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Fallido">Fallido</option>
                <option value="Reembolsado">Reembolsado</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" @bind="filtroMetodo">
                <option value="">Todos los métodos</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Efectivo">Efectivo</option>
                <option value="PayPal">PayPal</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" @bind="filtroCarrito">
                <option value="0">Todos los carritos</option>
                @foreach (var carrito in carritos)
                {
                    <option value="@carrito.Id">Carrito #@carrito.Id</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-info w-100" @onclick="MostrarFiltroFechas">Filtrar por Fechas</button>
        </div>
    </div>

    @if (mostrarFiltroFechas)
    {
        <div class="row mb-3 p-3 border rounded bg-light">
            <div class="col-md-4">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" @bind="fechaInicio" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" @bind="fechaFin" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary me-2" @onclick="AplicarFiltroFechas">Aplicar</button>
                <button class="btn btn-secondary" @onclick="LimpiarFiltroFechas">Limpiar</button>
            </div>
        </div>
    }

    @if (pagos?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Carrito</th>
                        <th>Usuario</th>
                        <th>Fecha Pago</th>
                        <th>Método</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Saldo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pago in pagosFiltrados)
                    {
                        <tr>
                            <td>@pago.Id</td>   
                            <td>
                                <small class="text-muted">#@pago.Carrito.Id</small><br>
                                <strong>@pago.Carrito?.Estado</strong>
                            </td>
                            <td>
                                @pago.Carrito?.Usuario?.Nombre<br>
                                <small class="text-muted">@pago.Carrito?.Usuario?.Email</small>
                            </td>
                            <td>@pago.FechaPago.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@pago.MetodoPago</td>
                            <td>@pago.MontoPagado.ToString("C")</td>
                            <td>
                                <span class="badge @GetEstadoPagoBadgeClass(pago.EstadoPago)">@pago.EstadoPago</span>
                            </td>
                            <td>@pago.Saldo.ToString("C")</td>
                            <td>
                                <button class="btn btn-sm btn-info" @onclick="() => VerDetalles(pago.Id)" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" @onclick="() => EditarPago(pago.Id)" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => EliminarPago(pago)" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => CambiarEstado(pago)" title="Cambiar estado">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="table-primary">
                        <td colspan="5" class="text-end"><strong>Total:</strong></td>
                        <td><strong>@pagosFiltrados.Sum(p => p.MontoPagado).ToString("C")</strong></td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="alert alert-info">
            <strong>Resumen:</strong>
            @pagosFiltrados.Count pagos -
            Total: @pagosFiltrados.Sum(p => p.MontoPagado).ToString("C")
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No se encontraron pagos.
        </div>
    }
}

@code {
    private List<Pago> pagos = new();
    private List<Pago> pagosFiltrados = new();
    private List<Carrito> carritos = new();
    private bool cargando = true;
    private string terminoBusqueda = string.Empty;
    private string filtroEstado = string.Empty;
    private string filtroMetodo = string.Empty;
    private int filtroCarrito = 0;
    private bool mostrarFiltroFechas = false;
    private DateTime fechaInicio = DateTime.Today.AddDays(-30);
    private DateTime fechaFin = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            var tasks = new Task[]
            {
                CargarPagos(),
                CargarCarritos()
            };

            await Task.WhenAll(tasks);
            FiltrarPagos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar datos: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task CargarPagos()
    {
        pagos = await Http.GetFromJsonAsync<List<Pago>>("api/Pagos") ?? new();
    }

    private async Task CargarCarritos()
    {
        carritos = await Http.GetFromJsonAsync<List<Carrito>>("api/Carritos") ?? new();
    }

    private void FiltrarPagos()
    {
        pagosFiltrados = pagos;

        if (!string.IsNullOrEmpty(terminoBusqueda))
        {
            pagosFiltrados = pagosFiltrados.Where(p =>
                p.Carrito?.Usuario?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                p.Carrito?.Usuario?.Email?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                p.MetodoPago?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true
            ).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEstado))
        {
            pagosFiltrados = pagosFiltrados.Where(p => p.EstadoPago == filtroEstado).ToList();
        }

        if (!string.IsNullOrEmpty(filtroMetodo))
        {
            pagosFiltrados = pagosFiltrados.Where(p => p.MetodoPago == filtroMetodo).ToList();
        }

        if (filtroCarrito > 0)
        {
            pagosFiltrados = pagosFiltrados.Where(p => p.CarritoId == filtroCarrito).ToList();
        }
    }

    private void OnBuscar(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? string.Empty;
        FiltrarPagos();
    }

    private string GetEstadoPagoBadgeClass(string estadoPago)
    {
        return estadoPago switch
        {
            "Completado" => "bg-success",
            "Pendiente" => "bg-warning",
            "Fallido" => "bg-danger",
            "Reembolsado" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private void MostrarFiltroFechas()
    {
        mostrarFiltroFechas = !mostrarFiltroFechas;
    }

    private async Task AplicarFiltroFechas()
    {
        try
        {
            var pagosFiltradosPorFecha = await Http.GetFromJsonAsync<List<Pago>>($"api/Pagos/GetByRangoFechas?fechaInicio={fechaInicio:yyyy-MM-dd}&fechaFin={fechaFin:yyyy-MM-dd}");
            if (pagosFiltradosPorFecha != null)
            {
                pagosFiltrados = pagosFiltradosPorFecha;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al filtrar por fechas: {ex.Message}");
        }
    }

    private async Task LimpiarFiltroFechas()
    {
        fechaInicio = DateTime.Today.AddDays(-30);
        fechaFin = DateTime.Today;
        await CargarPagos();
        FiltrarPagos();
    }

    private void NuevoPago()
    {
        Navigation.NavigateTo("/pagos/nuevo");
    }

    private async Task ProcesarPago()
    {
        var carritoId = await JS.InvokeAsync<string>("prompt", "Ingrese el ID del carrito:");
        var metodoPago = await JS.InvokeAsync<string>("prompt", "Ingrese el método de pago:", "Tarjeta");
        var montoPagado = await JS.InvokeAsync<string>("prompt", "Ingrese el monto a pagar:");
        var estadoPago = await JS.InvokeAsync<string>("prompt", "Ingrese el estado:", "Completado");

        if (!string.IsNullOrEmpty(carritoId) && !string.IsNullOrEmpty(metodoPago) && !string.IsNullOrEmpty(montoPagado))
        {
            if (int.TryParse(carritoId, out int carritoIdInt) && decimal.TryParse(montoPagado, out decimal monto))
            {
                try
                {
                    var request = new
                    {
                        CarritoId = carritoIdInt,
                        MetodoPago = metodoPago,
                        MontoPagado = monto,
                        EstadoPago = estadoPago ?? "Completado",
                        Saldo = 0m
                    };

                    var response = await Http.PostAsJsonAsync("api/Pagos/procesar-pago", request);

                    if (response.IsSuccessStatusCode)
                    {
                        await JS.InvokeVoidAsync("alert", "Pago procesado correctamente");
                        await CargarDatos();
                    }
                    else
                    {
                        var error = await response.Content.ReadAsStringAsync();
                        await JS.InvokeVoidAsync("alert", $"Error al procesar pago: {error}");
                    }
                }
                catch (Exception ex)
                {
                    await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
                }
            }
        }
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"/pagos/detalles/{id}");
    }

    private void EditarPago(int id)
    {
        Navigation.NavigateTo($"/pagos/editar/{id}");
    }

    private async Task EliminarPago(Pago pago)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar el pago #{pago.Id} por {pago.MontoPagado.ToString("C")}?");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/Pagos/{pago.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Pago eliminado correctamente");
                    await CargarDatos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al eliminar el pago");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task CambiarEstado(Pago pago)
    {
        var nuevoEstado = await JS.InvokeAsync<string>("prompt", "Ingrese el nuevo estado:", pago.EstadoPago);

        if (!string.IsNullOrEmpty(nuevoEstado))
        {
            try
            {
                var response = await Http.PostAsJsonAsync($"api/Pagos/actualizar-estado/{pago.Id}", nuevoEstado);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Estado del pago actualizado correctamente");
                    await CargarDatos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al actualizar el estado del pago");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task Refrescar()
    {
        await CargarDatos();
    }
}

@page "/pagos/detalles/{id:int}"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Detalles del Pago</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando información del pago...</p>
    </div>
}
else if (pago == null)
{
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i> Pago no encontrado
    </div>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i> Información del Pago
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted" width="40%"><strong>Fecha:</strong></td>
                            <td>@pago.FechaPago.ToString("dd/MM/yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Método:</strong></td>
                            <td>
                                <span class="badge bg-secondary">@pago.MetodoPago</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Monto:</strong></td>
                            <td class="text-success fw-bold fs-5">@pago.MontoPagado.ToString("C")</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Estado:</strong></td>
                            <td>
                                <span class="badge @GetEstadoPagoBadgeClass(pago.EstadoPago)">@pago.EstadoPago</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Saldo:</strong></td>
                            <td class="@(pago.Saldo > 0 ? "text-warning" : "text-success") fw-bold">
                                @pago.Saldo.ToString("C")
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i> Información del Carrito
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted" width="40%"><strong>Usuario:</strong></td>
                            <td>@pago.Carrito?.Usuario?.Nombre</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Email:</strong></td>
                            <td>@pago.Carrito?.Usuario?.Email</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Total Carrito:</strong></td>
                            <td class="fw-bold">@pago.Carrito?.MontoTotal.ToString("C")</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Estado Carrito:</strong></td>
                            <td>@pago.Carrito?.Estado</td>
                        </tr>
                        <tr>
                            <td class="text-muted"><strong>Estado Pago:</strong></td>
                            <td>@pago.Carrito?.EstadoPago</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i> Productos en el Carrito
                    </h5>
                </div>
                <div class="card-body">
                    @if (pago.Carrito?.CarritoProductos?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unitario</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in pago.Carrito.CarritoProductos)
                                    {
                                        <tr>
                                            <td>@item.Producto?.Nombre</td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">@item.Cantidad</span>
                                            </td>
                                            <td class="text-end">@item.PrecioUnitario.ToString("C")</td>
                                            <td class="text-end">
                                                <strong class="text-success">@((item.Cantidad * item.PrecioUnitario).ToString("C"))</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-primary">
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end">
                                            <strong class="fs-5">@pago.Carrito.MontoTotal.ToString("C")</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-box-open me-2"></i>No hay productos en el carrito.
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <div class="btn-group" role="group">
            <button class="btn btn-secondary" @onclick="Volver">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </button>
            <button class="btn btn-warning" @onclick="Editar">
                <i class="fas fa-pencil-alt me-1"></i> Editar
            </button>
            <button class="btn btn-info" @onclick="VerCarrito">
                <i class="fas fa-shopping-cart me-1"></i> Ver Carrito
            </button>
            <button class="btn btn-outline-primary" @onclick="CambiarEstado">
                <i class="fas fa-exchange-alt me-1"></i> Cambiar Estado
            </button>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Pago? pago;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarPago();
    }

    private async Task CargarPago()
    {
        try
        {
            pago = await Http.GetFromJsonAsync<Pago>($"api/Pagos/{Id}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error al cargar pago: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private string GetEstadoPagoBadgeClass(string estadoPago)
    {
        return estadoPago switch
        {
            "Completado" => "bg-success",
            "Pendiente" => "bg-warning",
            "Fallido" => "bg-danger",
            "Reembolsado" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private void Volver()
    {
        Navigation.NavigateTo("/pagos");
    }

    private void Editar()
    {
        Navigation.NavigateTo($"/pagos/editar/{Id}");
    }

    private void VerCarrito()
    {
        if (pago?.CarritoId > 0)
        {
            Navigation.NavigateTo($"/carritos/detalles/{pago.CarritoId}");
        }
    }

    private async Task CambiarEstado()
    {
        if (pago != null)
        {
            var nuevoEstado = await JS.InvokeAsync<string>("prompt",
                $"Ingrese el nuevo estado para el pago:",
                pago.EstadoPago);

            if (!string.IsNullOrEmpty(nuevoEstado))
            {
                try
                {
                    var response = await Http.PostAsJsonAsync($"api/Pagos/actualizar-estado/{Id}", nuevoEstado);

                    if (response.IsSuccessStatusCode)
                    {
                        await JS.InvokeVoidAsync("alert", "✅ Estado del pago actualizado correctamente");
                        await CargarPago();
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("alert", "❌ Error al actualizar el estado del pago");
                    }
                }
                catch (Exception ex)
                {
                    await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
                }
            }
        }
    }

    // Clases para la entidad
    public class Pago
    {
        public int Id { get; set; }
        public int CarritoId { get; set; }
        public DateTime FechaPago { get; set; }
        public string MetodoPago { get; set; } = string.Empty;
        public decimal MontoPagado { get; set; }
        public string EstadoPago { get; set; } = string.Empty;
        public decimal Saldo { get; set; }
        public Carrito? Carrito { get; set; }
    }

    public class Carrito
    {
        public int Id { get; set; }
        public Usuario? Usuario { get; set; }
        public decimal MontoTotal { get; set; }
        public string Estado { get; set; } = string.Empty;
        public string EstadoPago { get; set; } = string.Empty;
        public List<CarritoProducto> CarritoProductos { get; set; } = new();
    }

    public class Usuario
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    public class CarritoProducto
    {
        public int Id { get; set; }
        public int ProductoId { get; set; }
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; }
        public Producto? Producto { get; set; }
    }

    public class Producto
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
    }
}
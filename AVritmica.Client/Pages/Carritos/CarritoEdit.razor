@page "/carritos/editar/{id:int}"
@page "/carritos/nuevo"
@using AVritmica.Shared.DTO
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>@Titulo</h3>

<EditForm Model="carritoDTO" OnValidSubmit="GuardarCarrito">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="usuarioId" class="form-label">Usuario *</label>
                <InputSelect id="usuarioId" class="form-select" @bind-Value="carritoDTO.UsuarioId">
                    <option value="0">Seleccione un usuario</option>
                    @foreach (var usuario in usuarios)
                    {
                        <option value="@usuario.Id">@usuario.Nombre @usuario.Apellido - @usuario.Email</option>
                    }
                </InputSelect>
                @if (carritoDTO.UsuarioId == 0)
                {
                    <div class="text-danger">Debe seleccionar un usuario</div>
                }
            </div>

            <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <InputSelect id="estado" class="form-select" @bind-Value="carritoDTO.Estado">
                    <option value="Activo">Activo</option>
                    <option value="Confirmado">Confirmado</option>
                    <option value="Cancelado">Cancelado</option>
                    <option value="Completado">Completado</option>
                </InputSelect>
            </div>

            <div class="mb-3">
                <label for="estadoPago" class="form-label">Estado de Pago</label>
                <InputSelect id="estadoPago" class="form-select" @bind-Value="carritoDTO.EstadoPago">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Pagado">Pagado</option>
                    <option value="Parcial">Parcial</option>
                    <option value="Cancelado">Cancelado</option>
                </InputSelect>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="montoTotal" class="form-label">Monto Total</label>
                <InputNumber id="montoTotal" class="form-control" @bind-Value="carritoDTO.MontoTotal" />
            </div>

            <div class="mb-3">
                <label for="saldo" class="form-label">Saldo</label>
                <InputNumber id="saldo" class="form-control" @bind-Value="carritoDTO.Saldo" />
            </div>

            <div class="mb-3">
                <label for="direccionEnvio" class="form-label">Dirección de Envío</label>
                <InputTextArea id="direccionEnvio" class="form-control" @bind-Value="carritoDTO.DireccionEnvio" />
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary" disabled="@guardando">@BotonGuardarTexto</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private CarritoDTO carritoDTO = new();
    private List<Usuario> usuarios = new();
    private bool guardando = false;
    private bool EsEdicion => Id > 0;

    private string Titulo => EsEdicion ? "Editar Carrito" : "Nuevo Carrito";
    private string BotonGuardarTexto => guardando ? "Guardando..." : "Guardar";

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();

        if (EsEdicion)
        {
            await CargarCarrito();
        }
        else
        {
            // Valores por defecto para nuevo carrito
            carritoDTO.Estado = "Activo";
            carritoDTO.EstadoPago = "Pendiente";
            carritoDTO.FechaCreacion = DateTime.UtcNow;
        }
    }

    private async Task CargarUsuarios()
    {
        try
        {
            usuarios = await Http.GetFromJsonAsync<List<Usuario>>("api/Usuarios") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar usuarios: {ex.Message}");
        }
    }

    private async Task CargarCarrito()
    {
        try
        {
            var carrito = await Http.GetFromJsonAsync<Carrito>($"api/Carritos/{Id}");
            if (carrito != null)
            {
                carritoDTO = new CarritoDTO
                {
                    Id = carrito.Id,
                    UsuarioId = carrito.UsuarioId,
                    Estado = carrito.Estado,
                    EstadoPago = carrito.EstadoPago,
                    MontoTotal = carrito.MontoTotal,
                    Saldo = carrito.Saldo,
                    DireccionEnvio = carrito.DireccionEnvio,
                    FechaCreacion = carrito.FechaCreacion,
                    FechaConfirmacion = carrito.FechaConfirmacion
                };
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar carrito: {ex.Message}");
        }
    }

    private async Task GuardarCarrito()
    {
        // Validación del lado del cliente
        if (carritoDTO.UsuarioId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Por favor seleccione un usuario");
            return;
        }

        guardando = true;
        StateHasChanged();

        try
        {
            HttpResponseMessage response;

            if (EsEdicion)
            {
                // Asegurar que el ID esté establecido para edición
                carritoDTO.Id = Id;
                response = await Http.PutAsJsonAsync($"api/Carritos/actualizar/{Id}", carritoDTO);
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/Carritos/crear", carritoDTO);
            }

            if (response.IsSuccessStatusCode)
            {
                if (EsEdicion)
                {
                    await JS.InvokeVoidAsync("alert", "Carrito actualizado correctamente");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Carrito creado correctamente");
                }
                Navigation.NavigateTo("/carritos");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/carritos");
    }
}
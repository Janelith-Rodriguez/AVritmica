@page "/carritos"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gestión de Carritos</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoCarrito">
            <i class="fas fa-plus"></i> Nuevo Carrito
        </button>
        <button class="btn btn-outline-secondary" @onclick="Refrescar">
            <i class="fas fa-sync-alt"></i> Refrescar
        </button>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Buscar por usuario..." @bind="terminoBusqueda" @oninput="OnBuscar" />
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="filtroEstado">
                <option value="">Todos los estados</option>
                <option value="Activo">Activo</option>
                <option value="Confirmado">Confirmado</option>
                <option value="Completado">Completado</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="filtroEstadoPago">
                <option value="">Todos los estados de pago</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Pagado">Pagado</option>
                <option value="Parcial">Parcial</option>
                <option value="Cancelado">Cancelado</option>
            </select>
        </div>
        <div class="col-md-3">
            <small class="text-muted">Mostrando @carritosFiltrados.Count de @carritos.Count carritos</small>
        </div>
    </div>

    @if (carritos?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Usuario</th>
                        <th>Fecha Creación</th>
                        <th>Productos</th>
                        <th>Estado</th>
                        <th>Estado Pago</th>
                        <th>Monto Total</th>
                        <th>Saldo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var carrito in carritosFiltrados)
                    {
                        <tr>
                            <td>@carrito.Id</td>
                            <td>
                                <strong>@carrito.Usuario?.Nombre @carrito.Usuario?.Apellido</strong>
                                <br />
                                <small class="text-muted">@carrito.Usuario?.Email</small>
                            </td>
                            <td>@carrito.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <!-- NUEVO: Información de productos -->
                                @if (carrito.CarritoProductos?.Any() == true)
                                {
                                    <div>
                                        <span class="badge bg-primary">@carrito.CarritoProductos.Count producto(s)</span>
                                        <br />
                                        <small class="text-muted">
                                            @string.Join(", ", carrito.CarritoProductos.Take(2).Select(cp => $"{cp.Producto?.Nombre} ({cp.Cantidad})"))
                                            @if (carrito.CarritoProductos.Count > 2)
                                            {
                                                <text>y @(carrito.CarritoProductos.Count - 2) más...</text>
                                            }
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Sin productos</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetEstadoBadgeClass(carrito.Estado)" title="@GetEstadoTooltip(carrito.Estado)">@carrito.Estado</span>
                            </td>
                            <td>
                                <span class="badge @GetEstadoPagoBadgeClass(carrito.EstadoPago)" title="@GetEstadoPagoTooltip(carrito.EstadoPago)">@carrito.EstadoPago</span>
                            </td>
                            <td><strong>@carrito.MontoTotal.ToString("C")</strong></td>
                            <td class="@(carrito.Saldo > 0 ? "text-warning" : "text-success")">
                                <strong>@carrito.Saldo.ToString("C")</strong>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-info" @onclick="() => VerDetalles(carrito.Id)" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-warning" @onclick="() => EditarCarrito(carrito.Id)" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" @onclick="() => EliminarCarrito(carrito)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No se encontraron carritos.
        </div>
    }
}

@code {
    private List<Carrito> carritos = new();
    private List<Carrito> carritosFiltrados = new();
    private bool cargando = true;
    private string terminoBusqueda = string.Empty;
    private string filtroEstado = string.Empty;
    private string filtroEstadoPago = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarCarritos();
    }

    private async Task CargarCarritos()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            // Incluir productos y usuarios en la carga
            carritos = await Http.GetFromJsonAsync<List<Carrito>>("api/Carritos?incluirProductos=true&incluirUsuario=true") ?? new();
            FiltrarCarritos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar carritos: {ex.Message}");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private void FiltrarCarritos()
    {
        carritosFiltrados = carritos;

        if (!string.IsNullOrEmpty(terminoBusqueda))
        {
            carritosFiltrados = carritosFiltrados.Where(c =>
                c.Usuario?.Nombre?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                c.Usuario?.Apellido?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                c.Usuario?.Email?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true ||
                c.DireccionEnvio?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) == true
            ).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEstado))
        {
            carritosFiltrados = carritosFiltrados.Where(c => c.Estado == filtroEstado).ToList();
        }

        if (!string.IsNullOrEmpty(filtroEstadoPago))
        {
            carritosFiltrados = carritosFiltrados.Where(c => c.EstadoPago == filtroEstadoPago).ToList();
        }
    }

    private void OnBuscar(ChangeEventArgs e)
    {
        terminoBusqueda = e.Value?.ToString() ?? string.Empty;
        FiltrarCarritos();
    }

    private string GetEstadoBadgeClass(string estado)
    {
        return estado switch
        {
            "Activo" => "bg-primary",
            "Confirmado" => "bg-success",
            "Completado" => "bg-info",
            "Cancelado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetEstadoPagoBadgeClass(string estadoPago)
    {
        return estadoPago switch
        {
            "Pendiente" => "bg-warning text-dark",
            "Pagado" => "bg-success",
            "Parcial" => "bg-info",
            "Cancelado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    // NUEVOS MÉTODOS PARA TOOLTIPS
    private string GetEstadoTooltip(string estado)
    {
        return estado switch
        {
            "Activo" => "Carrito en proceso - El usuario está agregando productos",
            "Confirmado" => "Pedido confirmado - Esperando pago y envío",
            "Completado" => "Pedido completado - Entregrado y finalizado",
            "Cancelado" => "Carrito cancelado - No se procesará",
            _ => "Estado desconocido"
        };
    }

    private string GetEstadoPagoTooltip(string estadoPago)
    {
        return estadoPago switch
        {
            "Pendiente" => "No se ha realizado ningún pago",
            "Pagado" => "El monto total está completamente pagado",
            "Parcial" => "Se realizó un pago parcial",
            "Cancelado" => "Los pagos fueron cancelados/revertidos",
            _ => "Estado de pago desconocido"
        };
    }

    private void NuevoCarrito()
    {
        Navigation.NavigateTo("/carritos/nuevo");
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"/carritos/detalles/{id}");
    }

    private void EditarCarrito(int id)
    {
        Navigation.NavigateTo($"/carritos/editar/{id}");
    }

    private async Task EliminarCarrito(Carrito carrito)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar el carrito #{carrito.Id}?\n\nUsuario: {carrito.Usuario?.Nombre}\nProductos: {carrito.CarritoProductos?.Count ?? 0}\n\nEsta acción no se puede deshacer.");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/Carritos/{carrito.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Carrito eliminado correctamente");
                    await CargarCarritos();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "❌ Error al eliminar el carrito");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
            }
        }
    }

    private async Task Refrescar()
    {
        await CargarCarritos();
        await JS.InvokeVoidAsync("alert", "✅ Lista de carritos actualizada");
    }
}

@page "/consultas"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gestión de Consultas de Clientes</h3>

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando consultas...</p>
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary mb-0">@estadisticas.TotalConsultas</h4>
                                <small class="text-muted">Total Consultas</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning mb-0">@estadisticas.ConsultasNoLeidas</h4>
                                <small class="text-muted">Sin Leer</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success mb-0">@estadisticas.ConsultasHoy</h4>
                                <small class="text-muted">Hoy</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info mb-0">@estadisticas.ConsultasEstaSemana</h4>
                                <small class="text-muted">Esta Semana</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-primary" @onclick="ToggleFiltros">
                <i class="fas fa-filter me-1"></i> Filtros
            </button>
            <button class="btn btn-success" @onclick="NuevaConsulta">
                <i class="fas fa-plus me-1"></i> Nueva Consulta
            </button>
        </div>
    </div>

    @if (mostrarFiltros)
    {
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i> Filtros de Búsqueda
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" @bind="filtroEstado">
                                <option value="">Todos</option>
                                <option value="no-leidas">No Leídas</option>
                                <option value="leidas">Leídas</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" @bind="filtroFechaInicio" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" @bind="filtroFechaFin" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" @bind="filtroEmail" placeholder="Buscar por email..." />
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-primary" @onclick="AplicarFiltros">
                        <i class="fas fa-search me-1"></i> Aplicar Filtros
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
                        <i class="fas fa-broom me-1"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(mensajeInfo))
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> @mensajeInfo
        </div>
    }

    @if (consultasFiltradas?.Any() == true)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Mensaje</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Usuario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var consulta in consultasFiltradas)
                    {
                        <tr class="@((consulta.Leida ?? false) ? "" : "table-warning")">
                            <td>
                                <strong>@consulta.Nombre</strong>
                                @if (!(consulta.Leida ?? false))
                                {
                                    <span class="badge bg-danger ms-1">Nuevo</span>
                                }
                            </td>
                            <td>
                                <a href="mailto:@consulta.Email" class="text-decoration-none">
                                    <i class="fas fa-envelope me-1"></i> @consulta.Email
                                </a>
                            </td>
                            <td>
                                <div class="mensaje-truncado" title="@consulta.Mensaje">
                                    @(consulta.Mensaje.Length > 50 ? consulta.Mensaje.Substring(0, 50) + "..." : consulta.Mensaje)
                                </div>
                            </td>
                            <td>
                                <small>@consulta.FechaEnvio.ToString("dd/MM/yyyy HH:mm")</small>
                            </td>
                            <td>
                                @if (consulta.Leida ?? false)
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Leída
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>No Leída
                                    </span>
                                }
                            </td>
                            <td>
                                @if (consulta.Usuario != null)
                                {
                                    <small>@consulta.Usuario.Nombre</small>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Visitante</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-info" @onclick="() => VerConsulta(consulta)" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    @if (!(consulta.Leida ?? false))
                                    {
                                        <button class="btn btn-success" @onclick="() => MarcarComoLeida(consulta)" title="Marcar como leída">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    }
                                    <button class="btn btn-primary" @onclick="() => ResponderConsulta(consulta)" title="Responder">
                                        <i class="fas fa-reply"></i>
                                    </button>
                                    <button class="btn btn-danger" @onclick="() => EliminarConsulta(consulta)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span class="text-muted">
                    <i class="fas fa-list me-1"></i>
                    Mostrando @consultasFiltradas.Count de @consultas.Count consultas
                </span>
            </div>
            <div>
                <button class="btn btn-outline-info" @onclick="ExportarConsultas">
                    <i class="fas fa-download me-1"></i> Exportar
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning text-center py-4">
            <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
            <h4>No se encontraron consultas</h4>
            <p>@(consultas.Any() ? "No hay consultas que coincidan con los filtros aplicados." : "No hay consultas registradas en el sistema.")</p>
            @if (!consultas.Any())
            {
                <button class="btn btn-primary mt-2" @onclick="NuevaConsulta">
                    <i class="fas fa-plus me-1"></i> Crear Primera Consulta
                </button>
            }
        </div>
    }
}

@code {
    private List<Consulta> consultas = new();
    private List<Consulta> consultasFiltradas = new();
    private bool cargando = true;
    private bool mostrarFiltros = false;
    private string mensajeInfo = "";

    // Filtros
    private string filtroEstado = "";
    private string filtroEmail = "";
    private DateTime? filtroFechaInicio;
    private DateTime? filtroFechaFin;

    private EstadisticasConsultas estadisticas = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarConsultas();
        await CargarEstadisticas();
    }

    private async Task CargarConsultas()
    {
        cargando = true;
        StateHasChanged();

        try
        {
            consultas = await Http.GetFromJsonAsync<List<Consulta>>("api/Consultas") ?? new();
            consultasFiltradas = consultas;
            mensajeInfo = $"✅ Se cargaron {consultas.Count} consultas";
        }
        catch (Exception ex)
        {
            mensajeInfo = $"❌ Error al cargar consultas: {ex.Message}";
            consultas = new();
            consultasFiltradas = new();
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task CargarEstadisticas()
    {
        try
        {
            var noLeidas = await Http.GetFromJsonAsync<int>("api/Consultas/cantidad-no-leidas");
            var hoy = DateTime.Today;
            var inicioSemana = hoy.AddDays(-(int)hoy.DayOfWeek + 1); // Lunes de esta semana

            estadisticas = new EstadisticasConsultas
            {
                TotalConsultas = consultas.Count,
                ConsultasNoLeidas = noLeidas,
                ConsultasHoy = consultas.Count(c => c.FechaEnvio.Date == hoy),
                ConsultasEstaSemana = consultas.Count(c => c.FechaEnvio >= inicioSemana)
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando estadísticas: {ex.Message}");
        }
    }

    private void ToggleFiltros()
    {
        mostrarFiltros = !mostrarFiltros;
    }

    private void AplicarFiltros()
    {
        consultasFiltradas = consultas;

        // Aplicar filtro por estado
        if (!string.IsNullOrEmpty(filtroEstado))
        {
            consultasFiltradas = filtroEstado switch
            {
                "no-leidas" => consultasFiltradas.Where(c => !(c.Leida ?? false)).ToList(),
                "leidas" => consultasFiltradas.Where(c => c.Leida ?? false).ToList(),
                _ => consultasFiltradas
            };
        }

        // Aplicar filtro por email
        if (!string.IsNullOrEmpty(filtroEmail))
        {
            consultasFiltradas = consultasFiltradas
                .Where(c => c.Email.Contains(filtroEmail, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Aplicar filtro por fechas
        if (filtroFechaInicio.HasValue)
        {
            consultasFiltradas = consultasFiltradas
                .Where(c => c.FechaEnvio >= filtroFechaInicio.Value)
                .ToList();
        }

        if (filtroFechaFin.HasValue)
        {
            consultasFiltradas = consultasFiltradas
                .Where(c => c.FechaEnvio <= filtroFechaFin.Value.AddDays(1).AddSeconds(-1))
                .ToList();
        }

        mensajeInfo = $"✅ Se encontraron {consultasFiltradas.Count} consultas con los filtros aplicados";
        StateHasChanged();
    }

    private void LimpiarFiltros()
    {
        filtroEstado = "";
        filtroEmail = "";
        filtroFechaInicio = null;
        filtroFechaFin = null;
        consultasFiltradas = consultas;
        mensajeInfo = "✅ Filtros limpiados";
        StateHasChanged();
    }

    private void NuevaConsulta()
    {
        Navigation.NavigateTo("/consultas/nueva");
    }

    private void VerConsulta(Consulta consulta)
    {
        Navigation.NavigateTo($"/consultas/detalles/{consulta.Id}");
    }

    private async Task MarcarComoLeida(Consulta consulta)
    {
        try
        {
            var response = await Http.PostAsync($"api/Consultas/marcar-leida/{consulta.Id}", null);

            if (response.IsSuccessStatusCode)
            {
                consulta.Leida = true;
                await CargarEstadisticas();
                StateHasChanged();
                await JS.InvokeVoidAsync("alert", "✅ Consulta marcada como leída");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Error al marcar la consulta como leída");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
        }
    }

    private async Task ResponderConsulta(Consulta consulta)
    {
        var asunto = $"Re: Consulta de {consulta.Nombre} - AVritmica";
        var cuerpo = $"\n\n----------------------------------------\nConsulta original de {consulta.Nombre} ({consulta.Email}):\n{consulta.Mensaje}";

        var mailtoLink = $"mailto:{consulta.Email}?subject={Uri.EscapeDataString(asunto)}&body={Uri.EscapeDataString(cuerpo)}";
        await JS.InvokeVoidAsync("open", mailtoLink, "_blank");
    }

    private async Task EliminarConsulta(Consulta consulta)
    {
        var confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿Está seguro de eliminar la consulta de {consulta.Nombre}?\n\nEmail: {consulta.Email}\nFecha: {consulta.FechaEnvio.ToString("dd/MM/yyyy HH:mm")}\n\nEsta acción no se puede deshacer.");

        if (confirmado)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/Consultas/{consulta.Id}");

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "✅ Consulta eliminada correctamente");
                    await CargarConsultas();
                    await CargarEstadisticas();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "❌ Error al eliminar la consulta");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
            }
        }
    }

    private async Task ExportarConsultas()
    {
        try
        {
            var datosExportar = consultasFiltradas.Select(c => new
            {
                Nombre = c.Nombre,
                Email = c.Email,
                Mensaje = c.Mensaje.Replace("\"", "'"),
                Fecha = c.FechaEnvio.ToString("dd/MM/yyyy HH:mm"),
                Estado = (c.Leida ?? false) ? "Leída" : "No Leída",
                Usuario = c.Usuario?.Nombre ?? "Visitante"
            }).ToList();

            var resultado = await JS.InvokeAsync<bool>("exportarConsultasAExcel", datosExportar, "consultas-avritmica");

            if (resultado)
            {
                await JS.InvokeVoidAsync("alert", "✅ Consultas exportadas correctamente");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Error al exportar las consultas");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
        }
    }

    // Clases auxiliares
    public class Consulta
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Mensaje { get; set; } = string.Empty;
        public DateTime FechaEnvio { get; set; }
        public bool? Leida { get; set; }
        public Usuario? Usuario { get; set; }
    }

    public class Usuario
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    public class EstadisticasConsultas
    {
        public int TotalConsultas { get; set; }
        public int ConsultasNoLeidas { get; set; }
        public int ConsultasHoy { get; set; }
        public int ConsultasEstaSemana { get; set; }
    }
}

<style>
    .mensaje-truncado {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: help;
    }

    .table-warning {
        background-color: #fff3cd !important;
    }
</style>
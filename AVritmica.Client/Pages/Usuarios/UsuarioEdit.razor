@page "/usuarios/editar/{id:int}"
@page "/usuarios/nuevo"
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>@Titulo</h3>

<EditForm Model="usuario" OnValidSubmit="GuardarUsuario">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre *</label>
                <InputText id="nombre" class="form-control" @bind-Value="usuario.Nombre" />
                <ValidationMessage For="@(() => usuario.Nombre)" />
            </div>

            <div class="mb-3">
                <label for="apellido" class="form-label">Apellido</label>
                <InputText id="apellido" class="form-control" @bind-Value="usuario.Apellido" />
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">Email *</label>
                <InputText id="email" class="form-control" @bind-Value="usuario.Email" type="email" />
                <ValidationMessage For="@(() => usuario.Email)" />
            </div>

            <div class="mb-3">
                <label for="contrasena" class="form-label">Contraseña @(EsEdicion ? "(dejar vacío para no cambiar)" : "*")</label>
                <InputText id="contrasena" class="form-control" @bind-Value="usuario.Contrasena" type="password" />
                @if (!EsEdicion)
                {
                    <ValidationMessage For="@(() => usuario.Contrasena)" />
                }
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <InputText id="telefono" class="form-control" @bind-Value="usuario.Telefono" />
            </div>

            <div class="mb-3">
                <label for="direccion" class="form-label">Dirección</label>
                <InputTextArea id="direccion" class="form-control" @bind-Value="usuario.Direccion" />
            </div>

            <div class="mb-3">
                <label for="tipoUsuario" class="form-label">Tipo de Usuario *</label>
                <InputSelect id="tipoUsuario" class="form-select" @bind-Value="usuario.TipoUsuario">
                    <option value="Cliente">Cliente</option>
                    <option value="Administrador">Administrador</option>
                    <option value="Vendedor">Vendedor</option>
                </InputSelect>
                <ValidationMessage For="@(() => usuario.TipoUsuario)" />
            </div>

            @if (EsEdicion)
            {
                <div class="alert alert-info">
                    <small>
                        <strong>Fecha de registro:</strong> @fechaRegistro<br>
                        <strong>Carritos:</strong> @carritosCount activos / @carritosTotal total
                    </small>
                </div>
            }
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary" disabled="@guardando">@BotonGuardarTexto</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>

        @if (EsEdicion)
        {
            <button type="button" class="btn btn-warning" @onclick="CambiarContrasena">Cambiar Contraseña</button>
            <button type="button" class="btn btn-info" @onclick="ActualizarPerfil">Actualizar Perfil</button>
        }
    </div>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private Usuario usuario = new();
    private bool guardando = false;
    private bool EsEdicion => Id > 0;
    private string fechaRegistro = string.Empty;
    private int carritosCount = 0;
    private int carritosTotal = 0;

    private string Titulo => EsEdicion ? "Editar Usuario" : "Nuevo Usuario";
    private string BotonGuardarTexto => guardando ? "Guardando..." : "Guardar";

    protected override async Task OnInitializedAsync()
    {
        if (EsEdicion)
        {
            await CargarUsuario();
        }
        else
        {
            // Valores por defecto para nuevo usuario
            usuario.TipoUsuario = "Cliente";
        }
    }

    private async Task CargarUsuario()
    {
        try
        {
            usuario = await Http.GetFromJsonAsync<Usuario>($"api/Usuarios/{Id}") ?? new();

            // No mostrar la contraseña actual
            usuario.Contrasena = "";

            // Calcular estadísticas
            carritosCount = usuario.Carritos.Count(c => c.Estado == "Activo");
            carritosTotal = usuario.Carritos.Count;

            // Formatear fecha de registro (asumiendo que EntityBase tiene una propiedad FechaCreacion)
            fechaRegistro = DateTime.Now.ToString("dd/MM/yyyy HH:mm"); // Ajusta según tu EntityBase
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar usuario: {ex.Message}");
        }
    }

    private async Task GuardarUsuario()
    {
        // Validación adicional del lado del cliente
        if (string.IsNullOrEmpty(usuario.Nombre))
        {
            await JS.InvokeVoidAsync("alert", "Por favor ingrese el nombre");
            return;
        }

        if (string.IsNullOrEmpty(usuario.Email))
        {
            await JS.InvokeVoidAsync("alert", "Por favor ingrese el email");
            return;
        }

        if (!EsEdicion && string.IsNullOrEmpty(usuario.Contrasena))
        {
            await JS.InvokeVoidAsync("alert", "Por favor ingrese la contraseña");
            return;
        }

        guardando = true;
        StateHasChanged();

        try
        {
            HttpResponseMessage response;

            if (EsEdicion)
            {
                // Para edición, si no se cambió la contraseña, enviar string vacío
                if (string.IsNullOrEmpty(usuario.Contrasena))
                {
                    var usuarioSinContrasena = new Usuario
                    {
                        Id = usuario.Id,
                        Nombre = usuario.Nombre,
                        Apellido = usuario.Apellido,
                        Email = usuario.Email,
                        Contrasena = "", // No cambiar contraseña
                        Telefono = usuario.Telefono,
                        Direccion = usuario.Direccion,
                        TipoUsuario = usuario.TipoUsuario
                    };
                    response = await Http.PutAsJsonAsync($"api/Usuarios/{Id}", usuarioSinContrasena);
                }
                else
                {
                    response = await Http.PutAsJsonAsync($"api/Usuarios/{Id}", usuario);
                }
            }
            else
            {
                response = await Http.PostAsJsonAsync("api/Usuarios", usuario);
            }

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Usuario guardado correctamente");
                Navigation.NavigateTo("/usuarios");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private async Task CambiarContrasena()
    {
        var nuevaContrasena = await JS.InvokeAsync<string>("prompt", "Ingrese la nueva contraseña:");

        if (!string.IsNullOrEmpty(nuevaContrasena))
        {
            try
            {
                var response = await Http.PostAsJsonAsync($"api/Usuarios/cambiar-contrasena/{Id}", nuevaContrasena);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Contraseña cambiada correctamente");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al cambiar la contraseña");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private async Task ActualizarPerfil()
    {
        var nombre = await JS.InvokeAsync<string>("prompt", "Nombre:", usuario.Nombre);
        var apellido = await JS.InvokeAsync<string>("prompt", "Apellido:", usuario.Apellido);
        var telefono = await JS.InvokeAsync<string>("prompt", "Teléfono:", usuario.Telefono);
        var direccion = await JS.InvokeAsync<string>("prompt", "Dirección:", usuario.Direccion);

        if (!string.IsNullOrEmpty(nombre))
        {
            try
            {
                var request = new { Nombre = nombre, Apellido = apellido, Telefono = telefono, Direccion = direccion };
                var response = await Http.PostAsJsonAsync($"api/Usuarios/actualizar-perfil/{Id}", request);

                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "Perfil actualizado correctamente");
                    await CargarUsuario();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al actualizar el perfil");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
            }
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/usuarios");
    }
}
